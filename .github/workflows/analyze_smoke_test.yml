name: Analyze Smoke Test Results

on:
  workflow_run:
    workflows: ["CI â€” Build Sample Investor PDF (Smoke Test)"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get workflow information
        id: workflow_info
        run: |
          echo "WORKFLOW_NAME=${{ github.event.workflow_run.name }}" >> $GITHUB_ENV
          echo "RUN_ID=${{ github.event.workflow_run.id }}" >> $GITHUB_ENV
          echo "RUN_NUMBER=${{ github.event.workflow_run.run_number }}" >> $GITHUB_ENV
          echo "CONCLUSION=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_ENV
          echo "EVENT_NAME=${{ github.event.workflow_run.event }}" >> $GITHUB_ENV
          echo "BRANCH=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_ENV
          echo "SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          echo "ACTOR=${{ github.event.workflow_run.actor.login }}" >> $GITHUB_ENV
          echo "HTML_URL=${{ github.event.workflow_run.html_url }}" >> $GITHUB_ENV
          echo "REPOSITORY_URL=${{ github.event.repository.html_url }}" >> $GITHUB_ENV

      - name: Run analyzer
        run: |
          python .github/scripts/analyze_workflow.py

      - name: Capture PR comment content
        id: pr_comment
        run: |
          # Read the generated markdown file
          if [ -f "reports/ci_latest.md" ]; then
            echo "comment_file=reports/ci_latest.md" >> $GITHUB_OUTPUT
          fi

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push reports
        run: |
          git add reports/
          if [ -d "docs" ]; then
            git add docs/metrics.json
          fi
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update CI analysis reports [skip ci]"
            # Only push if there are local commits that haven't been pushed
            if git rev-parse @{u} > /dev/null 2>&1; then
              git push origin ${{ github.event.workflow_run.head_branch }}
            else
              echo "No upstream branch configured, skipping push"
            fi
          fi

      - name: Find PR number
        id: find_pr
        if: github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${{ github.event.workflow_run.head_branch }}`
            });
            
            if (pulls.length > 0) {
              core.setOutput('pr_number', pulls[0].number);
              return pulls[0].number;
            }
            return null;

      - name: Comment on PR
        if: steps.find_pr.outputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = ${{ steps.find_pr.outputs.pr_number }};
            
            let commentBody = '';
            if (fs.existsSync('reports/ci_latest.md')) {
              commentBody = fs.readFileSync('reports/ci_latest.md', 'utf8');
            } else {
              commentBody = '## CI Analysis\n\nAnalysis report not found.';
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('CI Build Status Report')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing PR comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('Created new PR comment');
            }

      - name: Summary
        if: always()
        run: |
          echo "### Smoke Test Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ env.WORKFLOW_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ env.RUN_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Conclusion**: ${{ env.CONCLUSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ env.BRANCH }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Reports generated in \`reports/\` directory" >> $GITHUB_STEP_SUMMARY
          if [ -d "docs" ]; then
            echo "ðŸ“‹ Metrics copied to \`docs/metrics.json\`" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ steps.find_pr.outputs.pr_number }}" ]; then
            echo "ðŸ’¬ PR #${{ steps.find_pr.outputs.pr_number }} commented" >> $GITHUB_STEP_SUMMARY
          fi
