name: Analyze Smoke Test Results

on:
  workflow_run:
    workflows: ["CI â€” Build Sample Investor PDF (Smoke Test)"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch for analyzer script
        uses: actions/checkout@v4
        with:
          ref: main
          path: trusted-scripts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get workflow information
        id: workflow_info
        env:
          BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}
        run: |
          echo "WORKFLOW_NAME=${{ github.event.workflow_run.name }}" >> $GITHUB_ENV
          echo "RUN_ID=${{ github.event.workflow_run.id }}" >> $GITHUB_ENV
          echo "RUN_NUMBER=${{ github.event.workflow_run.run_number }}" >> $GITHUB_ENV
          echo "CONCLUSION=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_ENV
          echo "EVENT_NAME=${{ github.event.workflow_run.event }}" >> $GITHUB_ENV
          echo "BRANCH=${BRANCH_NAME}" >> $GITHUB_ENV
          echo "SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          echo "ACTOR=${{ github.event.workflow_run.actor.login }}" >> $GITHUB_ENV
          echo "HTML_URL=${{ github.event.workflow_run.html_url }}" >> $GITHUB_ENV
          echo "REPOSITORY_URL=${{ github.event.repository.html_url }}" >> $GITHUB_ENV

      - name: Run analyzer
        run: |
          python trusted-scripts/.github/scripts/analyze_workflow.py

      - name: Checkout PR branch for committing reports
        # Security note: This checks out potentially untrusted code, but only for file operations.
        # We do not execute any code from this checkout. All analysis uses the trusted script
        # from the main branch. This checkout is necessary to commit reports back to the PR.
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: pr-branch

      - name: Copy reports to PR branch
        run: |
          mkdir -p pr-branch/reports
          cp reports/ci_latest.md pr-branch/reports/
          cp reports/metrics.json pr-branch/reports/
          if [ -d "pr-branch/docs" ]; then
            cp reports/metrics.json pr-branch/docs/
          fi

      - name: Capture PR comment content
        id: pr_comment
        run: |
          # Read the generated markdown file
          if [ -f "reports/ci_latest.md" ]; then
            echo "comment_file=reports/ci_latest.md" >> $GITHUB_OUTPUT
          fi

      - name: Configure Git
        working-directory: pr-branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push reports
        working-directory: pr-branch
        env:
          BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}
        run: |
          git add reports/
          if [ -d "docs" ]; then
            git add docs/metrics.json
          fi
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update CI analysis reports [skip ci]"
            # Attempt to push, but don't fail the workflow if push fails
            git push origin "HEAD:${BRANCH_NAME}" || {
              echo "Warning: Push failed. This may happen if the branch is protected or if there are concurrent updates."
              exit 0
            }
          fi

      - name: Find PR number
        id: find_pr
        if: github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        with:
          script: |
            const headBranch = process.env.HEAD_BRANCH;
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${headBranch}`
            });
            
            if (pulls.length > 0) {
              core.setOutput('pr_number', pulls[0].number);
              return pulls[0].number;
            }
            return null;

      - name: Comment on PR
        if: steps.find_pr.outputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = ${{ steps.find_pr.outputs.pr_number }};
            
            let commentBody = '';
            if (fs.existsSync('reports/ci_latest.md')) {
              commentBody = fs.readFileSync('reports/ci_latest.md', 'utf8');
            } else {
              commentBody = '## CI Analysis\n\nAnalysis report not found.';
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('CI Build Status Report')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing PR comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('Created new PR comment');
            }

      - name: Summary
        if: always()
        env:
          BRANCH_NAME: ${{ env.BRANCH }}
          WORKFLOW: ${{ env.WORKFLOW_NAME }}
          RUN: ${{ env.RUN_ID }}
          STATUS: ${{ env.CONCLUSION }}
        run: |
          echo "### Smoke Test Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${WORKFLOW}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${RUN}" >> $GITHUB_STEP_SUMMARY
          echo "- **Conclusion**: ${STATUS}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${BRANCH_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Reports generated in \`reports/\` directory" >> $GITHUB_STEP_SUMMARY
          if [ -d "pr-branch/docs" ]; then
            echo "ðŸ“‹ Metrics copied to \`docs/metrics.json\`" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ steps.find_pr.outputs.pr_number }}" ]; then
            echo "ðŸ’¬ PR #${{ steps.find_pr.outputs.pr_number }} commented" >> $GITHUB_STEP_SUMMARY
          fi
